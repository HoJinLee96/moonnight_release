<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{admin/main/base}">

<head>
	<title>견적서 조회</title>
	<style>
		/* --- 기본 레이아웃 --- */
		main {
			padding: 0 50px;
		}

		.search-container {
			max-width: 1000px;
			margin: 50px auto;
			padding: 40px;
			border: 1px solid #ddd;
			border-radius: 10px;
			background-color: #f9f9f9;
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		}

		h2.search-title {
			text-align: center;
			margin-bottom: 40px;
			border-bottom: 2px solid #20367a;
			padding-bottom: 15px;
		}

		.results-area {
			max-width: 1000px;
			margin: 30px auto;
		}

		/* --- 상태 박스 --- */
		.status-box-container {
			display: flex;
			justify-content: space-between;
			margin-bottom: 30px;
			gap: 10px;
		}

		.status-box {
			flex-grow: 1;
			background-color: #e9ecef;
			border-radius: 10px;
			padding: 20px;
			text-align: center;
			cursor: pointer;
			transition: all 0.3s;
			border: 2px solid transparent;
		}

		.status-box:hover,
		.status-box.active {
			background-color: #20367a;
			color: white;
			transform: translateY(-3px);
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		}

		.status-box-title {
			font-size: 16px;
			font-weight: bold;
			margin-bottom: 10px;
		}

		.status-box-count {
			font-size: 24px;
			font-weight: bold;
		}

		/* --- 검색 폼 --- */
		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			margin-bottom: 8px;
			font-weight: bold;
		}

		.form-group input,
		.form-group select {
			width: 100%;
			padding: 9px;
			border: 1px solid #ccc;
			border-radius: 5px;
			box-sizing: border-box;
			font-size: 16px;
		}

		.btn-container {
			text-align: right;
		}

		.btn {
			padding: 10px 25px;
			background-color: #20367a;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
		}

		.period-group {
			display: flex;
			gap: 10px;
			align-items: center;
		}

		/* --- 결과 리스트 --- */
		.results-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 15px;
		}

		.results-header h3 {
			margin: 0;
		}

		.results-header .size-selector label {
			margin-right: 10px;
		}

		.results-header .size-selector select {
			padding: 5px;
			border-radius: 5px;
		}

		.estimate-card {
			border: 1px solid #ddd;
			border-radius: 8px;
			margin-bottom: 15px;
			background-color: #fff;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
			transition: all 0.3s;
			cursor: pointer;
			padding: 20px 20px;
		}

		.estimate-card:hover {
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
			transform: translateY(-2px);
		}

		.no-results {
			text-align: center;
			padding: 50px;
			color: #777;
		}

		/* --- 페이지네이션 --- */
		#pagination-container {
			display: flex;
			justify-content: center;
			margin-top: 30px;
		}

		.pagination {
			display: flex;
			list-style: none;
			padding: 0;
		}

		.pagination .page-item a {
			color: #20367a;
			padding: 8px 12px;
			border: 1px solid #ddd;
			text-decoration: none;
			margin: 0 2px;
			transition: background-color 0.2s;
		}

		.pagination .page-item a:hover {
			background-color: #f0f0f0;
		}

		.pagination .page-item.active a {
			background-color: #20367a;
			color: white;
			border-color: #20367a;
		}

		.pagination .page-item.disabled a {
			color: #ccc;
			pointer-events: none;
		}

		/* --- 상세 보기 모달 --- */
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.6);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 1000;
		}

		.modal-content {
			background-color: white;
			padding: 30px;
			border-radius: 10px;
			width: 90%;
			max-width: 600px;
			max-height: 80vh;
			overflow-y: auto;
			position: relative;
			box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
		}

		.modal-close-btn {
			position: absolute;
			top: 15px;
			right: 15px;
			font-size: 24px;
			font-weight: bold;
			cursor: pointer;
			border: none;
			background: none;
		}

		.modal-content h3 {
			margin-top: 0;
			border-bottom: 1px solid #eee;
			padding-bottom: 10px;
		}

		.modal-details p {
			margin: 10px 0;
			line-height: 1.6;
		}

		.modal-details strong {
			color: #20367a;
		}

		.modal-images img {
			max-width: 100px;
			margin: 5px;
			border-radius: 5px;
			cursor: pointer;
		}

		.card-header h4 {
			margin: 0px;
		}

		.status-receive {
			color: green;
		}

		.status-in-progress {
			color: blue;
		}

		.status-complete {
			color: grey;
		}

		.status-delete {
			color: red;
		}
	</style>
</head>

<main layout:fragment="content">
	<!-- 검색 영역 -->
	<div class="search-container">
		<h2 class="search-title">관리자 견적서 조회</h2>
		<!-- 상태 박스 -->
		<div class="status-box-container">
			<div class="status-box" data-status="ALL">
				<div class="status-box-title">전체</div>
				<div class="status-box-count" id="count-all">0</div>
			</div>
			<div class="status-box" data-status="RECEIVE">
				<div class="status-box-title">접수</div>
				<div class="status-box-count" id="count-receive">0</div>
			</div>
			<div class="status-box" data-status="IN_PROGRESS">
				<div class="status-box-title">처리중</div>
				<div class="status-box-count" id="count-inprogress">0</div>
			</div>
			<div class="status-box" data-status="COMPLETE">
				<div class="status-box-title">완료</div>
				<div class="status-box-count" id="count-complete">0</div>
			</div>
			<div class="status-box" data-status="DELETE">
				<div class="status-box-title">삭제</div>
				<div class="status-box-count" id="count-delete">0</div>
			</div>
		</div>
		<!-- 검색 폼 -->
		<form id="adminEstimateSearchForm" onsubmit="return false;">
			<!-- ... 기존 검색 폼 필드들은 그대로 ... -->
			<div class="form-group">
				<label for="searchKeyword">검색어 (이름 / 연락처)</label>
				<input type="text" id="searchKeyword" placeholder="검색어를 입력하세요">
			</div>
			<div class="form-group">
				<label for="searchMainAddress">주소</label>
				<input type="text" id="searchMainAddress" placeholder="주소 입력">
			</div>
			<div class="form-group">
				<label for="searchCleaningService">청소 서비스 유형</label>
				<select id="searchCleaningService">
					<option value="">전체</option>
					<option th:each="service : ${cleaningServiceList}" th:value="${service.name()}"
						th:text="${service.label}">
					</option>
				</select>
			</div>
			<div class="form-group">
				<label>기간</label>
				<div class="period-group">
					<input type="date" id="searchDateFrom">
					<span>~</span>
					<input type="date" id="searchDateTo">
				</div>
			</div>
			<div class="btn-container">
				<button type="submit" class="btn">검색</button>
			</div>
		</form>
	</div>

	<!-- 검색 결과 영역 -->
	<div class="results-area">
		<div class="results-header">
			<h3>검색 결과</h3>
			<div class="size-selector">
				<label for="pageSizeSelect">개수:</label>
				<select id="pageSizeSelect">
					<option value="10">10개씩</option>
					<option value="20" selected>20개씩</option>
					<option value="50">50개씩</option>
				</select>
			</div>
		</div>
		<div id="estimate-results-container"></div>
		<div id="pagination-container"></div>
	</div>

	<!-- 견적 상세 보기 모달 -->
	<div id="estimate-detail-modal" class="modal-overlay">
		<div class="modal-content">
			<div id="modal-details-content" class="modal-details">
				<!-- JS가 여기에 상세 내용을 채워 넣을 것임 -->
			</div>
		</div>
	</div>
</main>

<th:block layout:fragment="script">
	<script th:inline="javascript">
		/*<![CDATA[*/
		const statusLabels = /*[[${estimateStatuses}]]*/ {};
		window.cleaningServices = /*[[${cleaningServices}]]*/null;
		/*]]>*/
	</script>

	<script type="module">
		import {searchEstimates, getEstimateById, updateEstimate, updateEstimateStatus, deleteEstimate} from '/js/admin/adminEstimate.js';
		import {openEditModal} from '/js/editModal.js';

		console.log(window.cleaningServices);
		// --- 상태 관리 (페이지의 모든 데이터를 관리하는 중앙 저장소) ---
		const state = {
			currentPage: 0,
			totalPages: 0,
			pageSize: 20,
			currentStatus: 'RECEIVE',
			estimates: [] // 현재 페이지의 견적 목록을 저장 (캐시용)
		};

		// --- DOM 요소 (자주 쓰는 HTML 요소를 미리 찾아두기) ---
		const dom = {
			searchForm: document.getElementById('adminEstimateSearchForm'),
			statusBoxes: document.querySelectorAll('.status-box'),
			resultsContainer: document.getElementById('estimate-results-container'),
			paginationContainer: document.getElementById('pagination-container'),
			modal: document.getElementById('estimate-detail-modal'),
			modalContent: document.getElementById('modal-details-content'),
			pageSizeSelect: document.getElementById('pageSizeSelect')
		};

		// --- 렌더링 함수 (데이터를 화면에 그리는 역할) ---

		const renderList = (estimates) => {
			dom.resultsContainer.innerHTML = '';
			if (!estimates || estimates.length === 0) {
				dom.resultsContainer.innerHTML = "<p class='no-results'>검색 결과가 없습니다.</p>";
				return;
			}

			const formatDate = (dateString) => new Date(dateString).toLocaleString('ko-KR').slice(0, -3);

			const listHtml = estimates.map(est => {
				const statusClass = `status-${est.estimateStatus.toLowerCase().replace('_', '-')}`;
				return `
						<div class="estimate-card" data-id="${est.estimateId}">
							<div class="card-header">
								<h4><span class="status-badge ${statusClass}">${statusLabels[est.estimateStatus] || ''}</span>
								#${est.estimateId} - ${est.cleaningService}</h4>
							</div>
							<div class="card-body">
								<p><strong>이름:</strong> ${est.name}</p>
								<p><strong>연락처:</strong> ${est.phone}</p>
								<p><strong>주소:</strong> ${est.mainAddress}</p>
							</div>
							<div class="card-footer">
								<span>신청일: ${formatDate(est.createdAt)}</span>
							</div>
						</div>
					`}).join('');
			dom.resultsContainer.innerHTML = listHtml;
		};

		const renderPagination = () => {
			dom.paginationContainer.innerHTML = '';
			if (state.totalPages <= 1) return;

			let paginationHtml = '<ul class="pagination">';
			const currentPage = state.currentPage;
			const totalPages = state.totalPages;

			paginationHtml += `<li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
						<a class="page-link" href="#" data-page="${currentPage - 1}">이전</a>
					</li>`;

			for (let i = 0; i < totalPages; i++) {
				paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
							<a class="page-link" href="#" data-page="${i}">${i + 1}</a>
						</li>`;
			}

			paginationHtml += `<li class="page-item ${currentPage >= totalPages - 1 ? 'disabled' : ''}">
						<a class="page-link" href="#" data-page="${currentPage + 1}">다음</a>
					</li>`;

			paginationHtml += '</ul>';
			dom.paginationContainer.innerHTML = paginationHtml;
		};

		const updateStatusCounts = (counts) => {
			document.getElementById('count-all').textContent = counts.all;
			document.getElementById('count-receive').textContent = counts.receive;
			document.getElementById('count-inprogress').textContent = counts.inProgress;
			document.getElementById('count-complete').textContent = counts.complete;
			document.getElementById('count-delete').textContent = counts.delete;
		};

		const renderModal = (data) => {
			// data가 null일 경우를 대비해 빈 객체로 기본값 설정
			const safeData = data || {};

			const formatDate = (dateString) => {
				// 날짜가 유효하지 않으면 빈 문자열 반환
				if (!dateString) return '';
				return new Date(dateString).toLocaleString('ko-KR');
			};

			const imagesHtml = safeData.images && safeData.images.length > 0
				? safeData.images.map(imgUrl => `<img src="${imgUrl}" alt="견적 이미지">`).join('')
				: '<p>첨부된 이미지가 없습니다.</p>';

			const statusClass = `status-${data.estimateStatus.toLowerCase().replace('_', '-')}`;


			// ★★★ 바로 여기! 모든 data 속성 뒤에 '?? ""'를 추가 ★★★
			dom.modalContent.innerHTML = `
		                <button type="button" class="modal-close-btn">&times;</button>
		                <h3>견적 상세 정보</h3>
		                <div class="modal-details">
							<p><strong>상태: <span class=${statusClass}>${statusLabels[safeData.estimateStatus] || ''}</span></p></strong>
		                    <p><strong>견적 번호:</strong> #${safeData.estimateId ?? ''}</p>
		                    <p><strong>신청자:</strong> ${safeData.name ?? ''}</p>
		                    <p><strong>연락처:</strong> ${safeData.phone ?? ''}</p>
		                    <p><strong>이메일:</strong> ${safeData.email ?? ''}</p>
		                    <p><strong>주소:</strong> (${safeData.postcode ?? ''}) ${safeData.mainAddress ?? ''} ${safeData.detailAddress ?? ''}</p>
		                    <p><strong>서비스:</strong> ${safeData.cleaningService ?? ''}</p>
		                    <p><strong>신청일:</strong> ${formatDate(safeData.createdAt)}</p>
		                    <p><strong>내용:</strong><br>${(safeData.content ?? '').replace(/\n/g, '<br>')}</p>
		                    <hr>
		                    <p><strong>첨부 이미지:</strong></p>
		                    <div class="modal-images">${imagesHtml}</div>
							<div class="detail-actions">
								<button type="button" class="btn btn-secondary btn-edit"}>수정</button>
								<button type="button" class="btn btn-secondary btn-delete"}>삭제</button>
							</div>
		                </div>
		            `;

			dom.modalContent.querySelector('.modal-close-btn').addEventListener('click', () => dom.modal.style.display = 'none');
			dom.modal.style.display = 'flex';

			dom.modalContent.querySelector('.btn-edit').addEventListener('click', () => {
				openEditModal(safeData, {
					updateApiFunction: updateEstimate,
					onSaveSuccess: (updatedEstimate) => {
						// 캐시 업데이트 및 리스트 다시 그리기
						state.estimate = state.estimate.map(item =>
							item.estimateId === updatedEstimate.estimateId ? updatedEstimate : item
						);
						// 수정 후에는 상세 보기 화면을 다시 그려주는 것이 더 좋은 경험
						renderModal(updatedEstimate);
					},
					modalOverlayParents: dom.modalContent
				});
			});
		};

		// --- 이벤트 핸들러 (사용자의 행동에 반응하는 함수) ---

		const handleSearch = async () => {
			const getElementValueOrNull = (id) => {
				const element = document.getElementById(id);
				const value = element ? element.value.trim() : '';
				return value === '' ? null : value;
			};

			const estimateSearchRequestDto = {
				estimateStatus: state.currentStatus || '',
				cleaningService: getElementValueOrNull('searchCleaningService'),
				searchWord: getElementValueOrNull('searchKeyword'),
				addressWord: getElementValueOrNull('searchMainAddress'),
				startDate: getElementValueOrNull('searchDateFrom'),
				endDate: getElementValueOrNull('searchDateTo'),
			};

			try {
				const data = await searchEstimates({
					estimateSearchRequestDto,
					page: state.currentPage,
					size: state.pageSize
				});

				state.estimates = data.estimateResponseDto;
				state.totalPages = Math.ceil(data.estimateSearchCount / state.pageSize);

				updateStatusCounts(data.estimateStatusCount);
				renderList(state.estimates);
				renderPagination();

			} catch (error) {
				alert(error.message);
				console.error('견적 검색 실패:', error);
			}
		};

		const handleCardClick = async (e) => {
			const card = e.target.closest('.estimate-card');
			if (!card) return;

			const estimateId = parseInt(card.dataset.id, 10);
			// state에 캐싱된 데이터에서 먼저 찾아봅니다.
			const estimate = state.estimates.find(est => est.estimateId === estimateId);

			if (estimate) {
				renderModal(estimate);
			} else {
				// 캐시에 없으면 API로 직접 조회합니다. (보통은 캐시에서 찾음)
				try {
					const detailedEstimate = await getEstimateById(estimateId);
					renderModal(detailedEstimate);
				} catch (error) {
					alert(error.message);
				}
			}
		};

		const setDefaultDates = () => {
			const toDate = new Date();
			const fromDate = new Date();
			fromDate.setMonth(toDate.getMonth() - 2);

			const toISO = (date) => date.toISOString().split('T')[0];

			document.getElementById('searchDateTo').value = toISO(toDate);
			document.getElementById('searchDateFrom').value = toISO(fromDate);
		};

		// --- 초기화 (페이지가 처음 로드될 때 실행되는 함수) ---
		const init = () => {
			// 초기 상태값에 맞게 UI를 설정합니다.
			document.querySelector(`.status-box[data-status="${state.currentStatus}"]`).classList.add('active');
			dom.pageSizeSelect.value = state.pageSize;
			setDefaultDates();

			// 각종 이벤트 리스너를 등록합니다.
			dom.searchForm.addEventListener('submit', (e) => {
				e.preventDefault();
				state.currentPage = 0;
				handleSearch();
			});

			dom.statusBoxes.forEach(box => {
				box.addEventListener('click', () => {
					dom.statusBoxes.forEach(b => b.classList.remove('active'));
					box.classList.add('active');
					state.currentStatus = box.dataset.status;
					state.currentPage = 0;
					handleSearch();
				});
			});

			dom.pageSizeSelect.addEventListener('change', (e) => {
				state.pageSize = parseInt(e.target.value, 10);
				state.currentPage = 0;
				handleSearch();
			});

			dom.paginationContainer.addEventListener('click', (e) => {
				const target = e.target.closest('.page-link');
				if (target && !target.parentElement.classList.contains('disabled')) {
					e.preventDefault();
					const page = parseInt(target.dataset.page, 10);
					if (!isNaN(page) && page >= 0) {
						state.currentPage = page;
						handleSearch();
					}
				}
			});

			dom.resultsContainer.addEventListener('click', handleCardClick);

			// 모달 바깥 영역 클릭 시 닫히도록 이벤트를 등록합니다.
			dom.modal.addEventListener('click', (e) => {
				if (e.target === dom.modal) {
					dom.modal.style.display = 'none';
				}
			});

			// 페이지 로드 후 첫 데이터 검색을 실행합니다.
			handleSearch();
		};

		// 삭제 처리
		async function handleDelete(estimateId) {
			if (confirm('정말로 이 견적서를 삭제하시겠습니까?')) {
				try {
					await deleteEstimateByAuth(estimateId);
					alert('삭제되었습니다.');
					// 리스트 재조회
					showLoading(true);
					const json = await getAllEstimateByAuth();
					cachedEstimates = json.data;
					showLoading(false);
					showEstimateList(cachedEstimates);
				} catch (error) {
					alert(error.message);
				}
			}
		}

		// DOM이 완전히 로드된 후 스크립트를 실행합니다.
		document.addEventListener('DOMContentLoaded', init);
	</script>
</th:block>